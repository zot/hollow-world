# Sequence: Friend Status Change (Mutual Acceptance)

**Source Spec:** friends.md, p2p-messages.md
**Existing Code:** src/p2p/HollowPeer.ts, src/p2p/FriendsManager.ts

## Participants

- **Peer A** (Alice)
- **HollowPeer A** (Alice's HollowPeer instance)
- **FriendsManager A** (Alice's FriendsManager)
- **P2PWebAppNetworkProvider A**
- **P2PWebAppClient A**
- **Peer B** (Bob)
- **HollowPeer B** (Bob's HollowPeer instance)
- **FriendsManager B** (Bob's FriendsManager)
- **P2PWebAppNetworkProvider B**
- **P2PWebAppClient B**

## Scenario 1: One-Way Friend Request

```
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                                                                                                                                                                                                               â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚Peer A â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚Peer Bâ”‚
     â”‚(Alice)â”‚                          â”‚HollowPeer Aâ”‚                                                      â”‚FriendsManager Aâ”‚               â”‚P2PWebAppNetworkProvider Aâ”‚                                â”‚P2PWebAppClient Aâ”‚                 â”‚(Bob) â”‚
     â””â”€â”€â”€â”¬â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”¬â”€â”€â”˜
         â”‚addFriend("Bob", bobPeerId, "notes") â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚addFriend({playerName: "Bob", peerId: bobPeerId, pending: 'unsent'}) â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚â”€â”€â”€â”€â”                                â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚    â”‚ friends.set(bobPeerId, friend) â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚<â”€â”€â”€â”˜                                â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚â”€â”€â”€â”€â”                                â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚    â”‚ persistFriends()               â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚<â”€â”€â”€â”˜                                â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                            Friend added                             â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚<â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚â”€â”€â”€â”€â”                                                                â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚    â”‚ unsentFriends.add(bobPeerId)                                   â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚<â”€â”€â”€â”˜                                                                â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                  â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚ â•‘{method: 'requestFriend', playerName: 'Alice'} â–‘â•‘                  â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚â”€â”€â”€â”€â”                                                                â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚    â”‚ Create IRequestFriendMessage                                   â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚<â”€â”€â”€â”˜                                                                â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                           sendMessage(bobPeerId, requestFriendMessage, onAck)                             â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚client.send(bobPeerId, protocol, message, ackHandler) â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚Send requestFriend via libp2p â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                                     â”‚                                                                     â”‚                                     â”‚                                                      â”‚                              â”‚   
         â”‚                    â•”â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—           â”‚   
         â”‚                    â•‘ ALT  â”‚  Message delivered successfully                                               â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•Ÿâ”€â”€â”€â”€â”€â”€â”˜         â”‚                                                                     â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚                  Ack handler fires                   â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                             onAck() callback        â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                        getFriend(bobPeerId)                         â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                        current friend data                          â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚<â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚â”€â”€â”€â”€â”                                                                â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚    â”‚ Check if pending still 'unsent'                                â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚<â”€â”€â”€â”˜                                                                â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚         updateFriend(bobPeerId, {..., pending: 'pending'})          â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚â”€â”€â”€â”€â”                                â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚    â”‚ persistFriends()               â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚<â”€â”€â”€â”˜                                â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚â”€â”€â”€â”€â”                                â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚    â”‚ notifyUpdateListeners()        â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚<â”€â”€â”€â”˜                                â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚â”€â”€â”€â”€â”                                                                â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚    â”‚ unsentFriends.delete(bobPeerId)                                â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚<â”€â”€â”€â”˜                                                                â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚                                                                     â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                   â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚ â•‘Status changed to 'pending' â³ â–‘â•‘                                   â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£           â”‚   
         â”‚                    â•‘ [Message not delivered]                                                              â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                           â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚ â•‘Friend stays pending: 'unsent' ğŸ“¤     â–‘â•‘                           â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•‘                â”‚ â•‘Will auto-retry when Bob comes online  â•‘                           â”‚                                     â”‚                                                      â”‚                  â•‘           â”‚   
         â”‚                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•           â”‚   
     â”Œâ”€â”€â”€â”´â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”´â”€â”€â”
     â”‚Peer A â”‚                          â”‚HollowPeer Aâ”‚                                                      â”‚FriendsManager Aâ”‚               â”‚P2PWebAppNetworkProvider Aâ”‚                                â”‚P2PWebAppClient Aâ”‚                 â”‚Peer Bâ”‚
     â”‚(Alice)â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚(Bob) â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                                                                                                                                                               â””â”€â”€â”€â”€â”€â”€â”˜
```

## Scenario 2: Bob Receives Friend Request

```
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      
     â”‚P2PWebAppClient Bâ”‚           â”‚P2PWebAppNetworkProvider Bâ”‚           â”‚HollowPeer Bâ”‚                                                                      â”‚FriendsManager Bâ”‚                                                      
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                      
              â”‚messageHandler(alicePeerId, data) â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚   messageHandler callback     â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚                               â”‚â”€â”€â”€â”€â”                                                                                â”‚                                                              
              â”‚                                  â”‚                               â”‚    â”‚ handleMessage(alicePeerId, requestFriendMessage)                               â”‚                                                              
              â”‚                                  â”‚                               â”‚<â”€â”€â”€â”˜                                                                                â”‚                                                              
              â”‚                                  â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚                               â”‚â”€â”€â”€â”€â”                                                                                â”‚                                                              
              â”‚                                  â”‚                               â”‚    â”‚ Validate message.method === 'requestFriend'                                    â”‚                                                              
              â”‚                                  â”‚                               â”‚<â”€â”€â”€â”˜                                                                                â”‚                                                              
              â”‚                                  â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚                               â”‚                               isBanned(alicePeerId)                                 â”‚                                                              
              â”‚                                  â”‚                               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                              
              â”‚                                  â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚                               â”‚                                       false                                         â”‚                                                              
              â”‚                                  â”‚                               â”‚<â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”‚                                                              
              â”‚                                  â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚                               â”‚                               getFriend(alicePeerId)                                â”‚                                                              
              â”‚                                  â”‚                               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                              
              â”‚                                  â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚                               â”‚                      undefined (Alice not in Bob's list yet)                        â”‚                                                              
              â”‚                                  â”‚                               â”‚<â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”‚                                                              
              â”‚                                  â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚                               â”‚                                                                                     â”‚                                                              
              â”‚                                  â”‚              â•”â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
              â”‚                                  â”‚              â•‘ ALT  â”‚  Alice not in Bob's friends list                                                              â”‚                                                             â•‘
              â”‚                                  â”‚              â•Ÿâ”€â”€â”€â”€â”€â”€â”˜         â”‚                                                                                     â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚â”€â”€â”€â”€â”                                                                                â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚    â”‚ Fire friendRequest event                                                       â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚<â”€â”€â”€â”˜                                                                                â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚â”€â”€â”€â”€â”                                                                                â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚    â”‚ eventService.emit('friendRequest', {peerId: alicePeerId, playerName: 'Alice'}) â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚<â”€â”€â”€â”˜                                                                                â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                                  â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚ â•‘UI can show notification/toast â–‘â•‘                                                  â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                  â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚     addFriend({playerName: 'Alice', peerId: alicePeerId, pending: 'pending'})       â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚â”€â”€â”€â”€â”                                                        â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚    â”‚ persistFriends()                                       â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚<â”€â”€â”€â”˜                                                        â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚â”€â”€â”€â”€â”                                                        â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚    â”‚ notifyUpdateListeners()                                â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚<â”€â”€â”€â”˜                                                        â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚                                                             â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—     â•‘
              â”‚                                  â”‚              â•‘                â”‚                                                                                     â”‚ â•‘Alice added to Bob's list with pending: 'pending' â³ â–‘â•‘     â•‘
              â”‚                                  â”‚              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                                      
     â”‚P2PWebAppClient Bâ”‚           â”‚P2PWebAppNetworkProvider Bâ”‚           â”‚HollowPeer Bâ”‚                                                                      â”‚FriendsManager Bâ”‚                                                      
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      
```

## Scenario 3: Mutual Acceptance (Bob Sends Friend Request Back)

```
     â”Œâ”€â”€â”€â”€â”€â”€â”                                                                                                                                                                                                                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                                                                                                                                                                                                                 
     â”‚Peer Bâ”‚                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚Peer A â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                
     â”‚(Bob) â”‚                                                   â”‚HollowPeer Bâ”‚                                                                       â”‚FriendsManager Bâ”‚           â”‚P2PWebAppNetworkProvider Bâ”‚                      â”‚P2PWebAppClient Bâ”‚          â”‚(Alice)â”‚          â”‚P2PWebAppClient Aâ”‚          â”‚P2PWebAppNetworkProvider Aâ”‚           â”‚HollowPeer Aâ”‚                                                                   â”‚FriendsManager Aâ”‚                                                
     â””â”€â”€â”€â”¬â”€â”€â”˜                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”¬â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                
         â”‚User clicks "Accept Friend Request" (or manually adds Alice) â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                               getFriend(alicePeerId)                                 â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                          friend (with pending: 'pending')                            â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚<â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                     â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚ â•‘{method: 'requestFriend', playerName: 'Bob'} â–‘â•‘                                     â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                     â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚â”€â”€â”€â”€â”                                                                                 â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚    â”‚ Create IRequestFriendMessage                                                    â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚<â”€â”€â”€â”˜                                                                                 â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                    sendMessage(alicePeerId, requestFriendMessage)    â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚client.send(alicePeerId, protocol, message) â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚  Send requestFriend   â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                â•”â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•—                                                
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                â•‘Alice receives Bob's requestFriend message                                                                                                                                                â–‘â•‘                                                
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•                                                
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚messageHandler(bobPeerId, data)  â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚   messageHandler callback     â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚â”€â”€â”€â”€â”                                                                             â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚    â”‚ handleMessage(bobPeerId, requestFriendMessage)                              â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚<â”€â”€â”€â”˜                                                                             â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                               isBanned(bobPeerId)                                â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                      false                                       â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚<â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                              getFriend(bobPeerId)                                â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                        friend (with pending: 'pending')                          â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚<â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•”â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘ ALT  â”‚  Friend exists with pending flag                                                           â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•Ÿâ”€â”€â”€â”€â”€â”€â”˜         â”‚                                                                                  â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚â”€â”€â”€â”€â”                                                                             â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚    â”‚ MUTUAL ACCEPTANCE DETECTED!                                                 â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚<â”€â”€â”€â”˜                                                                             â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚               updateFriend(bobPeerId, {..., pending: undefined})                 â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—     â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚ â•‘Clear pending flag â†’ friendship established âœ… â–‘â•‘     â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚â”€â”€â”€â”€â”                                                  â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚    â”‚ persistFriends()                                 â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚<â”€â”€â”€â”˜                                                  â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚â”€â”€â”€â”€â”                                                  â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚    â”‚ notifyUpdateListeners()                          â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚<â”€â”€â”€â”˜                                                  â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚â”€â”€â”€â”€â”                                                                             â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚    â”‚ Fire friendAccepted event                                                   â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚<â”€â”€â”€â”˜                                                                             â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚â”€â”€â”€â”€â”                                                                             â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚    â”‚ eventService.emit('friendAccepted', {peerId: bobPeerId, playerName: 'Bob'}) â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚<â”€â”€â”€â”˜                                                                             â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚                                                                                  â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                             â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•‘                â”‚ â•‘UI can show success notification â–‘â•‘                                             â”‚                                                       â•‘
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
    â•”â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•—                  â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
    â•‘Bob receives ack from Alice, also clears his pending flag                                                                                                                                                                                                           â–‘â•‘                  â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
    â•šâ•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•                  â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                 Ack handler from Alice's response                      â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                               getFriend(alicePeerId)                                 â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                          friend (with pending: 'pending')                            â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚<â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚â”€â”€â”€â”€â”                                                                                 â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚    â”‚ Check if Alice already sent requestFriend                                       â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚<â”€â”€â”€â”˜                                                                                 â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                           â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚ â•‘Alice DID send requestFriend (that's why Bob accepted) â–‘â•‘                           â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                           â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                updateFriend(alicePeerId, {..., pending: undefined})                  â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                        â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚ â•‘Clear pending flag â†’ mutual acceptance complete âœ… â–‘â•‘                        â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚â”€â”€â”€â”€â”                            â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚    â”‚ persistFriends()           â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚<â”€â”€â”€â”˜                            â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚â”€â”€â”€â”€â”                            â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚    â”‚ notifyUpdateListeners()    â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚<â”€â”€â”€â”˜                            â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚â”€â”€â”€â”€â”                                                                                 â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚    â”‚ Fire friendAccepted event                                                       â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚<â”€â”€â”€â”˜                                                                                 â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚                                                                                      â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚â”€â”€â”€â”€â”                                                                                 â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚    â”‚ eventService.emit('friendAccepted', {peerId: alicePeerId, playerName: 'Alice'}) â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
         â”‚                                                             â”‚<â”€â”€â”€â”˜                                                                                 â”‚                                 â”‚                                            â”‚                       â”‚                       â”‚                                 â”‚                               â”‚                                                                                  â”‚                                                        
     â”Œâ”€â”€â”€â”´â”€â”€â”                                                   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”´â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                                
     â”‚Peer Bâ”‚                                                   â”‚HollowPeer Bâ”‚                                                                       â”‚FriendsManager Bâ”‚           â”‚P2PWebAppNetworkProvider Bâ”‚                      â”‚P2PWebAppClient Bâ”‚          â”‚Peer A â”‚          â”‚P2PWebAppClient Aâ”‚          â”‚P2PWebAppNetworkProvider Aâ”‚           â”‚HollowPeer Aâ”‚                                                                   â”‚FriendsManager Aâ”‚                                                
     â”‚(Bob) â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚(Alice)â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                
     â””â”€â”€â”€â”€â”€â”€â”˜                                                                                                                                                                                                                                                    â””â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                                                                                                                                                                 
```

## Scenario 4: Both Peers Send Friend Request Simultaneously

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                                                                                       â”Œâ”€â”€â”€â”€â”€â”€â”                                                                                                            
                    â”‚Peer A â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚Peer Bâ”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           
                    â”‚(Alice)â”‚                 â”‚HollowPeer Aâ”‚                                           â”‚FriendsManager Aâ”‚           â”‚(Bob) â”‚                      â”‚HollowPeer Bâ”‚                                           â”‚FriendsManager Bâ”‚           
                    â””â”€â”€â”€â”¬â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”¬â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           
                 â•”â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•—           
                 â•‘Alice and Bob both add each other at same time (race condition)                                                                                                                                                          â–‘â•‘           
                 â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•           
                        â”‚addFriend("Bob", bobPeerId) â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                   
                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                   
                        â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                   
                        â”‚                            â”‚                                                          â”‚                       â”‚addFriend("Alice", alicePeerId) â”‚                                                          â”‚                   
                        â”‚                            â”‚                                                          â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                                          â”‚                   
                        â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                   
                 â•”â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•—           
                 â•‘Both create friends with pending: 'unsent'                                                                                                                                                                               â–‘â•‘           
                 â•‘Both add to unsentFriends set                                                                                                                                                                                             â•‘           
                 â•‘Both try to send requestFriend                                                                                                                                                                                            â•‘           
                 â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•           
                        â”‚                            â”‚â”€â”€â”€â”€â”                                                     â”‚                       â”‚                                â”‚                                                          â”‚                   
                        â”‚                            â”‚    â”‚ sendMessage(bobPeerId, requestFriendMessage)        â”‚                       â”‚                                â”‚                                                          â”‚                   
                        â”‚                            â”‚<â”€â”€â”€â”˜                                                     â”‚                       â”‚                                â”‚                                                          â”‚                   
                        â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                   
                        â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚â”€â”€â”€â”€â”                                                     â”‚                   
                        â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚    â”‚ sendMessage(alicePeerId, requestFriendMessage)      â”‚                   
                        â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚<â”€â”€â”€â”˜                                                     â”‚                   
                        â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                   
                 â•”â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•—           
                 â•‘Both messages cross in flight                                                                                                                                                                                            â–‘â•‘           
                 â•šâ•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•           
                        â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                   
          â•”â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘ ALT  â”‚  Both messages delivered          â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•Ÿâ”€â”€â”€â”€â”€â”€â”˜      â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚â”€â”€â”€â”€â”                                                     â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚    â”‚ Ack received â†’ Change to pending: 'pending'         â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚<â”€â”€â”€â”˜                                                     â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚â”€â”€â”€â”€â”                                                     â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚    â”‚ Ack received â†’ Change to pending: 'pending'         â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚<â”€â”€â”€â”˜                                                     â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚â”€â”€â”€â”€â”                                                     â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚    â”‚ Receive Bob's requestFriend                         â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚<â”€â”€â”€â”˜                                                     â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚â”€â”€â”€â”€â”                                                     â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚    â”‚ Friend exists with pending flag â†’ MUTUAL ACCEPTANCE â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚<â”€â”€â”€â”˜                                                     â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚   updateFriend(bobPeerId, {..., pending: undefined})     â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚â”€â”€â”€â”€â”                                                     â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚    â”‚ Receive Alice's requestFriend                       â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚<â”€â”€â”€â”˜                                                     â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚â”€â”€â”€â”€â”                                                     â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚    â”‚ Friend exists with pending flag â†’ MUTUAL ACCEPTANCE â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚<â”€â”€â”€â”˜                                                     â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚  updateFriend(alicePeerId, {..., pending: undefined})    â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â•‘
          â•‘             â”‚                            â”‚                                                          â”‚                       â”‚                                â”‚                                                          â”‚                  â•‘
          â•‘      â•”â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•—          â•‘
          â•‘      â•‘Friendship established for both! âœ…                                                                                                                                                                                       â–‘â•‘          â•‘
          â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    â”Œâ”€â”€â”€â”´â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”´â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           
                    â”‚Peer A â”‚                 â”‚HollowPeer Aâ”‚                                           â”‚FriendsManager Aâ”‚           â”‚Peer Bâ”‚                      â”‚HollowPeer Bâ”‚                                           â”‚FriendsManager Bâ”‚           
                    â”‚(Alice)â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚(Bob) â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           
                    â””â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                                       â””â”€â”€â”€â”€â”€â”€â”˜                                                                                                            
```

## State Transitions

```
[No Friend Entry] â†’ addFriend() â†’ [pending: 'unsent' ğŸ“¤]
                                      â†“ sendMessage ack received
                                  [pending: 'pending' â³]
                                      â†“ requestFriend received (mutual)
                                  [pending: undefined âœ…]
                                      â†“ friendship established
                                  [Accepted Friend]
```

## Spec Intent

Matches spec requirements:
- **Stubborn Delivery**: Auto-retry unsent requests when peer connects
- **Two-State Pending**: 'unsent' (not delivered) vs 'pending' (delivered, awaiting mutual)
- **Mutual Acceptance**: Both peers must send requestFriend to establish friendship
- **No Explicit Accept**: Sending requestFriend IS the acceptance
- **Idempotent**: Simultaneous requests handled gracefully (race condition safe)
- **Event Emission**: friendRequest and friendAccepted events for UI
- **Ban Checking**: Silently ignore requests from banned peers
- **Persistent**: Pending status saved to storage

## Analysis

### Correctly Implemented âœ…

1. **Two-State Pending**: 'unsent' (not delivered) and 'pending' (awaiting mutual)
2. **Stubborn Delivery**: Ack handler pattern with auto-retry
3. **Mutual Acceptance Detection**: Check for existing friend with pending flag
4. **Event Emission**: friendRequest and friendAccepted events
5. **Ban Handling**: Check isBanned() before processing
6. **Race Condition Safe**: Simultaneous requests both clear pending flags
7. **Storage Persistence**: All state changes persisted immediately
8. **Update Listeners**: UI reactivity via observer pattern

### No Issues Found

Implementation correctly handles all mutual acceptance scenarios including race conditions.
