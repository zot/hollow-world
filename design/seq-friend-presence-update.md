# Sequence: Friend Presence Update

**Source Spec:** friends.md, p2p.md
**Existing Code:** src/p2p/HollowPeer.ts, src/p2p/P2PWebAppNetworkProvider.ts

## Participants

- **P2PWebAppClient** (src/p2p/client/client.js)
- **P2PWebAppNetworkProvider** (src/p2p/P2PWebAppNetworkProvider.ts)
- **HollowPeer** (src/p2p/HollowPeer.ts)
- **FriendsManager** (src/p2p/FriendsManager.ts)
- **EventService** (src/services/EventService.ts)
- **FriendsView** (src/ui/FriendsView.ts)

## Initial Presence Initialization (App Startup)

```
           ┌───────┐          ┌──────────┐                                   ┌────────────────────────┐                  ┌───────────────┐          ┌──────────────┐                                                           
           │main.ts│          │HollowPeer│                                   │P2PWebAppNetworkProvider│                  │P2PWebAppClient│          │FriendsManager│                                                           
           └───┬───┘          └─────┬────┘                                   └────────────┬───────────┘                  └───────┬───────┘          └───────┬──────┘                                                           
               │   initialize()     │                                                     │                                      │                          │                                                                  
               │───────────────────>│                                                     │                                      │                          │                                                                  
               │                    │                                                     │                                      │                          │                                                                  
               │                    │                    initialize()                     │                                      │                          │                                                                  
               │                    │────────────────────────────────────────────────────>│                                      │                          │                                                                  
               │                    │                                                     │                                      │                          │                                                                  
               │                    │                                                     │ ╔════════════════════════════════════╧═══════════════════════╗  │                                                                  
               │                    │                                                     │ ║WebSocket connected, peer initialized, subscribed to topic ░║  │                                                                  
               │                    │                                                     │ ╚════════════════════════════════════╤═══════════════════════╝  │                                                                  
               │                    │                                                     │          listPeers(topic)            │                          │                                                                  
               │                    │                                                     │─────────────────────────────────────>│                          │                                                                  
               │                    │                                                     │                                      │                          │                                                                  
               │                    │                                                     │          Array of peer IDs           │                          │                                                                  
               │                    │                                                     │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                          │                                                                  
               │                    │                                                     │                                      │                          │                                                                  
               │                    │                                                     │────┐                                 │                          │                                                                  
               │                    │                                                     │    │ connectedPeers = new Set(peers) │                          │                                                                  
               │                    │                                                     │<───┘                                 │                          │                                                                  
               │                    │                                                     │                                      │                          │                                                                  
               │                    │────┐                                                │                                      │                          │                                                                  
               │                    │    │ initializeFriendPresence()                     │                                      │                          │                                                                  
               │                    │<───┘                                                │                                      │                          │                                                                  
               │                    │                                                     │                                      │                          │                                                                  
               │                    │                getConnectedPeers()                  │                                      │                          │                                                                  
               │                    │────────────────────────────────────────────────────>│                                      │                          │                                                                  
               │                    │                                                     │                                      │                          │                                                                  
               │                    │            Array of connected peer IDs              │                                      │                          │                                                                  
               │                    │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │                                      │                          │                                                                  
               │                    │                                                     │                                      │                          │                                                                  
               │                    │                                                   getAllFriends()                          │                          │                                                                  
               │                    │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                                                                  
               │                    │                                                     │                                      │                          │                                                                  
               │                    │                                                 Map<peerId, IFriend>                       │                          │                                                                  
               │                    │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │                                                                  
               │                    │                                                     │                                      │                          │                                                                  
               │                    │                                                     │                                      │                          │                                                                  
          ╔════╪══╤═════════════════╪═════════════════════════════════════════════════════╪══════════════════════════════════════╪══════════════════════════╪═════════════════════════════════════════════════════════════════╗
          ║ LOOP  │  For each friend in friends list                                      │                                      │                          │                                                                 ║
          ╟───────┘                 │                                                     │                                      │                          │                                                                 ║
          ║    │                    │────┐                                                │                                      │                          │                                                                 ║
          ║    │                    │    │ Check if friend.peerId in connectedPeers array │                                      │                          │                                                                 ║
          ║    │                    │<───┘                                                │                                      │                          │                                                                 ║
          ║    │                    │                                                     │                                      │                          │                                                                 ║
          ║    │                    │                                                     │                                      │                          │                                                                 ║
          ║    │    ╔══════╤════════╪═════════════════════════════════════════════════════╪══════════════════════════════════════╪══════════════════════════╪═══════════════════════════════════════════════════════╗         ║
          ║    │    ║ ALT  │  Peer is online                                              │                                      │                          │                                                       ║         ║
          ║    │    ╟──────┘        │                                                     │                                      │                          │                                                       ║         ║
          ║    │    ║               │────┐                                                │                                      │                          │                                                       ║         ║
          ║    │    ║               │    │ Log "Friend ${playerName} is online"           │                                      │                          │                                                       ║         ║
          ║    │    ║               │<───┘                                                │                                      │                          │                                                       ║         ║
          ║    │    ║               │                                                     │                                      │                          │                                                       ║         ║
          ║    │    ║               │                                  updateFriend(peerId, {...friend, presence: true})         │                          │                                                       ║         ║
          ║    │    ║               │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                                                       ║         ║
          ║    │    ║               │                                                     │                                      │                          │                                                       ║         ║
          ║    │    ║               │                                                     │                                      │                          │────┐                                                  ║         ║
          ║    │    ║               │                                                     │                                      │                          │    │ friends.set(peerId, updatedFriend)               ║         ║
          ║    │    ║               │                                                     │                                      │                          │<───┘                                                  ║         ║
          ║    │    ║               │                                                     │                                      │                          │                                                       ║         ║
          ║    │    ║               │                                                     │                                      │                          │ ╔══════════════════════════════╗                      ║         ║
          ║    │    ║               │                                                     │                                      │                          │ ║NOT persisted - runtime only ░║                      ║         ║
          ║    │    ║               │                                                     │                                      │                          │ ╚══════════════════════════════╝                      ║         ║
          ║    │    ║               │                                                     │                                      │                          │────┐                                                  ║         ║
          ║    │    ║               │                                                     │                                      │                          │    │ notifyUpdateListeners(peerId, updatedFriend)     ║         ║
          ║    │    ║               │                                                     │                                      │                          │<───┘                                                  ║         ║
          ║    │    ╠═══════════════╪═════════════════════════════════════════════════════╪══════════════════════════════════════╪══════════════════════════╪═══════════════════════════════════════════════════════╣         ║
          ║    │    ║ [Peer is offline]                                                   │                                      │                          │                                                       ║         ║
          ║    │    ║               │────┐                                                │                                      │                          │                                                       ║         ║
          ║    │    ║               │    │ Log "Friend ${playerName} is offline"          │                                      │                          │                                                       ║         ║
          ║    │    ║               │<───┘                                                │                                      │                          │                                                       ║         ║
          ║    │    ║               │                                                     │                                      │                          │                                                       ║         ║
          ║    │    ║               │                                  updateFriend(peerId, {...friend, presence: false})        │                          │                                                       ║         ║
          ║    │    ║               │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                                                       ║         ║
          ║    │    ║               │                                                     │                                      │                          │                                                       ║         ║
          ║    │    ║               │                                                     │                                      │                          │────┐                                                  ║         ║
          ║    │    ║               │                                                     │                                      │                          │    │ friends.set(peerId, updatedFriend)               ║         ║
          ║    │    ║               │                                                     │                                      │                          │<───┘                                                  ║         ║
          ║    │    ║               │                                                     │                                      │                          │                                                       ║         ║
          ║    │    ║               │                                                     │                                      │                          │ ╔══════════════════════════════╗                      ║         ║
          ║    │    ║               │                                                     │                                      │                          │ ║NOT persisted - runtime only ░║                      ║         ║
          ║    │    ║               │                                                     │                                      │                          │ ╚══════════════════════════════╝                      ║         ║
          ║    │    ║               │                                                     │                                      │                          │────┐                                                  ║         ║
          ║    │    ║               │                                                     │                                      │                          │    │ notifyUpdateListeners(peerId, updatedFriend)     ║         ║
          ║    │    ║               │                                                     │                                      │                          │<───┘                                                  ║         ║
          ║    │    ╚═══════════════╪═════════════════════════════════════════════════════╪══════════════════════════════════════╪══════════════════════════╪═══════════════════════════════════════════════════════╝         ║
          ╚════╪════════════════════╪═════════════════════════════════════════════════════╪══════════════════════════════════════╪══════════════════════════╪═════════════════════════════════════════════════════════════════╝
               │                    │                                                     │                                      │                          │                                                                  
               │            ╔═══════╧═════════════════════════════════════════════════════╧══════════════════════════════════════╧══════════════════════════╧═══════╗                                                          
               │            ║All friends now have presence field initialized (true or false)                                                                       ░║                                                          
           ┌───┴───┐        ╚═══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╝                                                          
           │main.ts│          │HollowPeer│                                   │P2PWebAppNetworkProvider│                  │P2PWebAppClient│          │FriendsManager│                                                           
           └───────┘          └──────────┘                                   └────────────────────────┘                  └───────────────┘          └──────────────┘                                                           
```

## Peer Join Event (Friend Comes Online)

```
     ┌───────────────┐           ┌────────────────────────┐                 ┌──────────┐                                     ┌──────────────┐                                     ┌────────────┐           ┌───────────┐                                        
     │P2PWebAppClient│           │P2PWebAppNetworkProvider│                 │HollowPeer│                                     │FriendsManager│                                     │EventService│           │FriendsView│                                        
     └───────┬───────┘           └────────────┬───────────┘                 └─────┬────┘                                     └───────┬──────┘                                     └──────┬─────┘           └─────┬─────┘                                        
     ╔═══════╧════════════════════════════════╧═══════════════════════════════════╧══════════════════════════════════════════════════╧═══════════════════════════════════════════════════╧═══════════════════════╧═══════╗                                      
     ║Remote peer joins the 'hollow-world' pubsub topic                                                                                                                                                                 ░║                                      
     ╚═══════╤════════════════════════════════╤═══════════════════════════════════╤══════════════════════════════════════════════════╤═══════════════════════════════════════════════════╤═══════════════════════╤═══════╝                                      
             │────┐                           │                                   │                                                  │                                                   │                       │                                              
             │    │ Detect peer joined event  │                                   │                                                  │                                                   │                       │                                              
             │<───┘                           │                                   │                                                  │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │peerChangeHandler(peerId, true) │                                   │                                                  │                                                   │                       │                                              
             │───────────────────────────────>│                                   │                                                  │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │────┐                              │                                                  │                                                   │                       │                                              
             │                                │    │ handlePeerJoined(peerId)     │                                                  │                                                   │                       │                                              
             │                                │<───┘                              │                                                  │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │────┐                              │                                                  │                                                   │                       │                                              
             │                                │    │ connectedPeers.add(peerId)   │                                                  │                                                   │                       │                                              
             │                                │<───┘                              │                                                  │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │────┐                              │                                                  │                                                   │                       │                                              
             │                                │    │ Log "Peer joined: ${peerId}" │                                                  │                                                   │                       │                                              
             │                                │<───┘                              │                                                  │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │    peerConnectHandler(peerId)     │                                                  │                                                   │                       │                                              
             │                                │──────────────────────────────────>│                                                  │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │                                   │────┐                                             │                                                   │                       │                                              
             │                                │                                   │    │ handlePeerConnection(peerId)                │                                                   │                       │                                              
             │                                │                                   │<───┘                                             │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │                                   │────┐                                             │                                                   │                       │                                              
             │                                │                                   │    │ updateFriendPresence(peerId, true)          │                                                   │                       │                                              
             │                                │                                   │<───┘                                             │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │                                   │                getFriend(peerId)                 │                                                   │                       │                                              
             │                                │                                   │─────────────────────────────────────────────────>│                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │                                   │               friend or undefined                │                                                   │                       │                                              
             │                                │                                   │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │                   ╔══════╤════════╪══════════════════════════════════════════════════╪═══════════════════════════════════════════════════╪═══════════════════════╪═════════════════════════════════════════════╗
             │                                │                   ║ ALT  │  Peer is a friend                                         │                                                   │                       │                                             ║
             │                                │                   ╟──────┘        │                                                  │                                                   │                       │                                             ║
             │                                │                   ║               │────┐                                             │                                                   │                       │                                             ║
             │                                │                   ║               │    │ Log "Friend ${playerName} came online"      │                                                   │                       │                                             ║
             │                                │                   ║               │<───┘                                             │                                                   │                       │                                             ║
             │                                │                   ║               │                                                  │                                                   │                       │                                             ║
             │                                │                   ║               │updateFriend(peerId, {...friend, presence: true}) │                                                   │                       │                                             ║
             │                                │                   ║               │─────────────────────────────────────────────────>│                                                   │                       │                                             ║
             │                                │                   ║               │                                                  │                                                   │                       │                                             ║
             │                                │                   ║               │                                                  │────┐                                              │                       │                                             ║
             │                                │                   ║               │                                                  │    │ friends.set(peerId, updatedFriend)           │                       │                                             ║
             │                                │                   ║               │                                                  │<───┘                                              │                       │                                             ║
             │                                │                   ║               │                                                  │                                                   │                       │                                             ║
             │                                │                   ║               │                                                  │ ╔══════════════════════════════╗                  │                       │                                             ║
             │                                │                   ║               │                                                  │ ║NOT persisted - runtime only ░║                  │                       │                                             ║
             │                                │                   ║               │                                                  │ ╚══════════════════════════════╝                  │                       │                                             ║
             │                                │                   ║               │                                                  │────┐                                              │                       │                                             ║
             │                                │                   ║               │                                                  │    │ notifyUpdateListeners(peerId, updatedFriend) │                       │                                             ║
             │                                │                   ║               │                                                  │<───┘                                              │                       │                                             ║
             │                                │                   ║               │                                                  │                                                   │                       │                                             ║
             │                                │                   ║               │                                                  │                         Update listener callback  │                       │                                             ║
             │                                │                   ║               │                                                  │──────────────────────────────────────────────────────────────────────────>│                                             ║
             │                                │                   ║               │                                                  │                                                   │                       │                                             ║
             │                                │                   ║               │                                                  │                                                   │                       │────┐                                        ║
             │                                │                   ║               │                                                  │                                                   │                       │    │ refreshView()                          ║
             │                                │                   ║               │                                                  │                                                   │                       │<───┘                                        ║
             │                                │                   ║               │                                                  │                                                   │                       │                                             ║
             │                                │                   ║               │                                                  │                                                   │                       │────┐                                        ║
             │                                │                   ║               │                                                  │                                                   │                       │    │ Re-render with 🟢 online indicator     ║
             │                                │                   ║               │                                                  │                                                   │                       │<───┘                                        ║
             │                                │                   ║               │                                                  │                                                   │                       │                                             ║
             │                                │                   ║               │                                                  │                                                   │                       │ ╔═══════════════════════════════╗           ║
             │                                │                   ║               │                                                  │                                                   │                       │ ║UI now shows friend as online ░║           ║
             │                                │                   ║               │                                                  │                                                   │                       │ ╚═══════════════════════════════╝           ║
             │                                │                   ║               │                       emit('friendPresenceChanged', {peerId, presence: true})                        │                       │                                             ║
             │                                │                   ║               │─────────────────────────────────────────────────────────────────────────────────────────────────────>│                       │                                             ║
             │                                │                   ║               │                                                  │                                                   │                       │                                             ║
             │                                │                   ║               │                                                  │                                                   │ ╔═════════════════════╧════════════════════════╗                    ║
             │                                │                   ║               │                                                  │                                                   │ ║Other components can subscribe to this event ░║                    ║
             │                                │                   ╠═══════════════╪══════════════════════════════════════════════════╪═══════════════════════════════════════════════════╪═════════════════════════════════════════════════════════════════════╣
             │                                │                   ║ [Peer is not a friend]                                           │                                                   │                       │                                             ║
             │                                │                   ║               │────┐                                             │                                                   │                       │                                             ║
             │                                │                   ║               │    │ Log "Non-friend peer connected: ${peerId}"  │                                                   │                       │                                             ║
             │                                │                   ║               │<───┘                                             │                                                   │                       │                                             ║
             │                                │                   ║               │                                                  │                                                   │                       │                                             ║
             │                                │                   ║               │ ╔═══════════════════════════╗                    │                                                   │                       │                                             ║
             │                                │                   ║               │ ║No presence update needed ░║                    │                                                   │                       │                                             ║
             │                                │                   ╚═══════════════╪═╚═══════════════════════════╝════════════════════╪═══════════════════════════════════════════════════╪═══════════════════════╪═════════════════════════════════════════════╝
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │                                   │────┐                                             │                                                   │                       │                                              
             │                                │                                   │    │ Check if peerId in unsentFriends set        │                                                   │                       │                                              
             │                                │                                   │<───┘                                             │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │                                   │                                                  │                                                   │                       │                                              
             │                                │                   ╔══════╤════════╪══════════════════════════════════════════════════╪═══════╗                                           │                       │                                              
             │                                │                   ║ ALT  │  Peer has unsent friend request                           │       ║                                           │                       │                                              
             │                                │                   ╟──────┘        │                                                  │       ║                                           │                       │                                              
             │                                │                   ║               │────┐                                             │       ║                                           │                       │                                              
             │                                │                   ║               │    │ Auto-retry sending friend request           │       ║                                           │                       │                                              
             │                                │                   ║               │<───┘                                             │       ║                                           │                       │                                              
             │                                │                   ║               │                                                  │       ║                                           │                       │                                              
             │                                │                   ║               │ ╔════════════════════════════════════════════════╧═╗     ║                                           │                       │                                              
             │                                │                   ║               │ ║Stubborn delivery - retry when peer comes online ░║     ║                                           │                       │                                              
             │                                │                   ╚═══════════════╪═╚══════════════════════════════════════════════════╝═════╝                                           │                       │                                              
     ┌───────┴───────┐           ┌────────────┴───────────┐                 ┌─────┴────┐                                     ┌───────┴──────┐                                     ┌──────┴─────┐           ┌─────┴─────┐                                        
     │P2PWebAppClient│           │P2PWebAppNetworkProvider│                 │HollowPeer│                                     │FriendsManager│                                     │EventService│           │FriendsView│                                        
     └───────────────┘           └────────────────────────┘                 └──────────┘                                     └──────────────┘                                     └────────────┘           └───────────┘                                        
```

## Peer Leave Event (Friend Goes Offline)

```
     ┌───────────────┐            ┌────────────────────────┐                  ┌──────────┐                                       ┌──────────────┐                                     ┌────────────┐           ┌───────────┐                                        
     │P2PWebAppClient│            │P2PWebAppNetworkProvider│                  │HollowPeer│                                       │FriendsManager│                                     │EventService│           │FriendsView│                                        
     └───────┬───────┘            └────────────┬───────────┘                  └─────┬────┘                                       └───────┬──────┘                                     └──────┬─────┘           └─────┬─────┘                                        
     ╔═══════╧═════════════════════════════════╧════════════════════════════════════╧════════════════════════════════════════════════════╧═══════════════════════════════════════════════════╧═══════════════════════╧═══════╗                                      
     ║Remote peer leaves the 'hollow-world' pubsub topic                                                                                                                                                                    ░║                                      
     ╚═══════╤═════════════════════════════════╤════════════════════════════════════╤════════════════════════════════════════════════════╤═══════════════════════════════════════════════════╤═══════════════════════╤═══════╝                                      
             │────┐                            │                                    │                                                    │                                                   │                       │                                              
             │    │ Detect peer left event     │                                    │                                                    │                                                   │                       │                                              
             │<───┘                            │                                    │                                                    │                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │peerChangeHandler(peerId, false) │                                    │                                                    │                                                   │                       │                                              
             │────────────────────────────────>│                                    │                                                    │                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │────┐                               │                                                    │                                                   │                       │                                              
             │                                 │    │ handlePeerLeft(peerId)        │                                                    │                                                   │                       │                                              
             │                                 │<───┘                               │                                                    │                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │────┐                               │                                                    │                                                   │                       │                                              
             │                                 │    │ connectedPeers.delete(peerId) │                                                    │                                                   │                       │                                              
             │                                 │<───┘                               │                                                    │                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │────┐                               │                                                    │                                                   │                       │                                              
             │                                 │    │ Log "Peer left: ${peerId}"    │                                                    │                                                   │                       │                                              
             │                                 │<───┘                               │                                                    │                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │   peerDisconnectHandler(peerId)    │                                                    │                                                   │                       │                                              
             │                                 │───────────────────────────────────>│                                                    │                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │                                    │────┐                                               │                                                   │                       │                                              
             │                                 │                                    │    │ handlePeerDisconnection(peerId)               │                                                   │                       │                                              
             │                                 │                                    │<───┘                                               │                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │                                    │────┐                                               │                                                   │                       │                                              
             │                                 │                                    │    │ updateFriendPresence(peerId, false)           │                                                   │                       │                                              
             │                                 │                                    │<───┘                                               │                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │                                    │                 getFriend(peerId)                  │                                                   │                       │                                              
             │                                 │                                    │───────────────────────────────────────────────────>│                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │                                    │                friend or undefined                 │                                                   │                       │                                              
             │                                 │                                    │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │                    ╔══════╤════════╪════════════════════════════════════════════════════╪═══════════════════════════════════════════════════╪═══════════════════════╪═════════════════════════════════════════════╗
             │                                 │                    ║ ALT  │  Peer is a friend                                           │                                                   │                       │                                             ║
             │                                 │                    ╟──────┘        │                                                    │                                                   │                       │                                             ║
             │                                 │                    ║               │────┐                                               │                                                   │                       │                                             ║
             │                                 │                    ║               │    │ Log "Friend ${playerName} went offline"       │                                                   │                       │                                             ║
             │                                 │                    ║               │<───┘                                               │                                                   │                       │                                             ║
             │                                 │                    ║               │                                                    │                                                   │                       │                                             ║
             │                                 │                    ║               │updateFriend(peerId, {...friend, presence: false})  │                                                   │                       │                                             ║
             │                                 │                    ║               │───────────────────────────────────────────────────>│                                                   │                       │                                             ║
             │                                 │                    ║               │                                                    │                                                   │                       │                                             ║
             │                                 │                    ║               │                                                    │────┐                                              │                       │                                             ║
             │                                 │                    ║               │                                                    │    │ friends.set(peerId, updatedFriend)           │                       │                                             ║
             │                                 │                    ║               │                                                    │<───┘                                              │                       │                                             ║
             │                                 │                    ║               │                                                    │                                                   │                       │                                             ║
             │                                 │                    ║               │                                                    │ ╔══════════════════════════════╗                  │                       │                                             ║
             │                                 │                    ║               │                                                    │ ║NOT persisted - runtime only ░║                  │                       │                                             ║
             │                                 │                    ║               │                                                    │ ╚══════════════════════════════╝                  │                       │                                             ║
             │                                 │                    ║               │                                                    │────┐                                              │                       │                                             ║
             │                                 │                    ║               │                                                    │    │ notifyUpdateListeners(peerId, updatedFriend) │                       │                                             ║
             │                                 │                    ║               │                                                    │<───┘                                              │                       │                                             ║
             │                                 │                    ║               │                                                    │                                                   │                       │                                             ║
             │                                 │                    ║               │                                                    │                         Update listener callback  │                       │                                             ║
             │                                 │                    ║               │                                                    │──────────────────────────────────────────────────────────────────────────>│                                             ║
             │                                 │                    ║               │                                                    │                                                   │                       │                                             ║
             │                                 │                    ║               │                                                    │                                                   │                       │────┐                                        ║
             │                                 │                    ║               │                                                    │                                                   │                       │    │ refreshView()                          ║
             │                                 │                    ║               │                                                    │                                                   │                       │<───┘                                        ║
             │                                 │                    ║               │                                                    │                                                   │                       │                                             ║
             │                                 │                    ║               │                                                    │                                                   │                       │────┐                                        ║
             │                                 │                    ║               │                                                    │                                                   │                       │    │ Re-render with ⚫ offline indicator     ║
             │                                 │                    ║               │                                                    │                                                   │                       │<───┘                                        ║
             │                                 │                    ║               │                                                    │                                                   │                       │                                             ║
             │                                 │                    ║               │                                                    │                                                   │                       │ ╔════════════════════════════════╗          ║
             │                                 │                    ║               │                                                    │                                                   │                       │ ║UI now shows friend as offline ░║          ║
             │                                 │                    ║               │                                                    │                                                   │                       │ ╚════════════════════════════════╝          ║
             │                                 │                    ║               │                       emit('friendPresenceChanged', {peerId, presence: false})                         │                       │                                             ║
             │                                 │                    ║               │───────────────────────────────────────────────────────────────────────────────────────────────────────>│                       │                                             ║
             │                                 │                    ╠═══════════════╪════════════════════════════════════════════════════╪═══════════════════════════════════════════════════╪═══════════════════════╪═════════════════════════════════════════════╣
             │                                 │                    ║ [Peer is not a friend]                                             │                                                   │                       │                                             ║
             │                                 │                    ║               │────┐                                               │                                                   │                       │                                             ║
             │                                 │                    ║               │    │ Log "Non-friend peer disconnected: ${peerId}" │                                                   │                       │                                             ║
             │                                 │                    ║               │<───┘                                               │                                                   │                       │                                             ║
             │                                 │                    ║               │                                                    │                                                   │                       │                                             ║
             │                                 │                    ║               │ ╔═══════════════════════════╗                      │                                                   │                       │                                             ║
             │                                 │                    ║               │ ║No presence update needed ░║                      │                                                   │                       │                                             ║
             │                                 │                    ╚═══════════════╪═╚═══════════════════════════╝══════════════════════╪═══════════════════════════════════════════════════╪═══════════════════════╪═════════════════════════════════════════════╝
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │                                    │────┐                                               │                                                   │                       │                                              
             │                                 │                                    │    │ Clean up any in-flight messages to this peer  │                                                   │                       │                                              
             │                                 │                                    │<───┘                                               │                                                   │                       │                                              
             │                                 │                                    │                                                    │                                                   │                       │                                              
             │                                 │                                    │ ╔═════════════════════════════════════════╗        │                                                   │                       │                                              
             │                                 │                                    │ ║Remove from resendable queue if present ░║        │                                                   │                       │                                              
     ┌───────┴───────┐            ┌────────────┴───────────┐                  ┌─────┴─╚═════════════════════════════════════════╝┌───────┴──────┐                                     ┌──────┴─────┐           ┌─────┴─────┐                                        
     │P2PWebAppClient│            │P2PWebAppNetworkProvider│                  │HollowPeer│                                       │FriendsManager│                                     │EventService│           │FriendsView│                                        
     └───────────────┘            └────────────────────────┘                  └──────────┘                                       └──────────────┘                                     └────────────┘           └───────────┘                                        
```

## App Restart (Presence Reset)

**Flow:**
- User closes browser tab → All presence data LOST (non-persisted)
- User reopens browser tab → `main.ts` calls `HollowPeer.initialize()`
- `FriendsManager.loadFriends()` loads friends WITHOUT presence field (undefined)
- `HollowPeer.initializeFriendPresence()` rebuilds presence from current connectedPeers set

## Presence Field Characteristics

**Key Properties:**
- **Runtime Only**: NEVER persisted to storage
- **Initialized on Startup**: Set based on connectedPeers at init time
- **Updated on Events**: Changed when peers join/leave topic
- **Stale-Proof**: Always reflects current network state (no stale data)
- **Optional Field**: Can be undefined before initialization
- **Three States**: undefined (not initialized) | true (online) | false (offline)

## Spec Intent

Matches spec requirements:
- **Non-Persistent Presence**: Runtime-only field avoids stale data
- **Initialization on Startup**: Set from connectedPeers at init
- **Event-Driven Updates**: Updated on peer join/leave events
- **UI Reactivity**: Observer pattern notifies FriendsView
- **Event Emission**: friendPresenceChanged for other components
- **Friend-Only Tracking**: Only update presence for actual friends
- **Stale-Free Design**: Always reflects current network state

## Analysis

### Correctly Implemented ✅

1. **Non-Persistent Design**: Presence NOT saved to storage (avoids stale data)
2. **Initialization on Startup**: initializeFriendPresence() rebuilds from network
3. **Event-Driven Updates**: Peer join/leave events trigger presence changes
4. **Observer Pattern**: Update listeners notify UI of changes
5. **Event Service**: friendPresenceChanged event for decoupled components
6. **Friend Filtering**: Only track presence for actual friends
7. **Three-State Logic**: undefined, true, false (clear semantics)
8. **UI Indicators**: 🟢 online, ⚫ offline badges in FriendsView

### Key Design Decision

**Why Non-Persistent?**
- If persisted, could show stale online/offline status
- Network state changes while app is closed
- Rebuilding from live network state ensures accuracy
- Small performance cost (one listPeers call at startup)
- Big reliability gain (no stale presence indicators)

### No Issues Found

Presence tracking design is excellent - non-persistent field prevents stale state issues.
