# Sequence: Add Friend by Peer ID

**Source Spec:** specs/friends.md, specs/ui.friends.md
**Existing Code:** src/ui/FriendsView.ts, src/p2p/HollowPeer.ts

## Participants

- **User**
- **FriendsView** (src/ui/FriendsView.ts)
- **MilkdownUtils** (src/utils/MilkdownUtils.ts)
- **HollowPeer** (src/p2p/HollowPeer.ts)
- **FriendsManager** (src/p2p/FriendsManager.ts)
- **P2PWebAppNetworkProvider** (src/p2p/P2PWebAppNetworkProvider.ts)
- **LogService** (src/services/LogService.ts)

## Current Implementation

```
                    ┌────┐                                                              ┌───────────┐                                 ┌─────────────┐          ┌──────────┐                                             ┌──────────────┐                               ┌────────────────────────┐                                  ┌──────────┐           
                    │User│                                                              │FriendsView│                                 │MilkdownUtils│          │HollowPeer│                                             │FriendsManager│                               │P2PWebAppNetworkProvider│                                  │LogService│           
                    └──┬─┘                                                              └─────┬─────┘                                 └──────┬──────┘          └─────┬────┘                                             └───────┬──────┘                               └────────────┬───────────┘                                  └─────┬────┘           
                       │                Click "Add Friend by Peer ID" button                  │                                              │                       │                                                          │                                                   │                                                    │                
                       │─────────────────────────────────────────────────────────────────────>│                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │────┐                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │    │ showAddFriendModal()                    │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │<───┘                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │      createEditor(notesContainer, '')        │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │─────────────────────────────────────────────>│                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │            newFriendNotesEditor              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                           Modal displayed                            │                                              │                       │                                                          │                                                   │                                                    │                
                       │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                     Enter name, peer ID, notes                       │                                              │                       │                                                          │                                                   │                                                    │                
                       │─────────────────────────────────────────────────────────────────────>│                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                      Click "Add Friend" button                       │                                              │                       │                                                          │                                                   │                                                    │                
                       │─────────────────────────────────────────────────────────────────────>│                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │────┐                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │    │ handleAddFriend()                       │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │<───┘                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │────┐                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │    │ Validate name not empty                 │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │<───┘                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │────┐                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │    │ Validate peer ID not empty              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │<───┘                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │────┐                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │    │ isValidPeerId(friendPeerId)             │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │<───┘                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │────┐                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │    │ Check base58 format (alphanumeric only) │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │<───┘                                         │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
                       │                                                                      │                                              │                       │                                                          │                                                   │                                                    │                
          ╔══════╤═════╪══════════════════════════════════════════════════════════════════════╪══════════════════════════════════════════════╪═══════════════════════╪══════════════════════════════════════════════════════════╪═══════════════════════════════════════════════════╪════════════════════════════════════════════════════╪═══════════════╗
          ║ ALT  │  Invalid peer ID format                                                    │                                              │                       │                                                          │                                                   │                                                    │               ║
          ╟──────┘     │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                   Alert "Invalid peer ID format"                     │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │─ ─ ┐                                         │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │    | Return early                            │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │< ─ ┘                                         │                       │                                                          │                                                   │                                                    │               ║
          ╠════════════╪══════════════════════════════════════════════════════════════════════╪══════════════════════════════════════════════╪═══════════════════════╪══════════════════════════════════════════════════════════╪═══════════════════════════════════════════════════╪════════════════════════════════════════════════════╪═══════════════╣
          ║ [Valid peer ID format]                                                            │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │      getMarkdown(newFriendNotesEditor)       │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │─────────────────────────────────────────────>│                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                    notes                     │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │             addFriend(friendName, friendPeerId, notes)               │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │─────────────────────────────────────────────────────────────────────>│                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │────┐                                                     │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │    │ Validate name and peer ID not empty                 │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │<───┘                                                     │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │addFriend({playerName, peerId, notes, pending: 'unsent'}) │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │─────────────────────────────────────────────────────────>│                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │────┐                                              │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │    │ friends.set(peerId, friend)                  │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │<───┘                                              │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │────┐                                              │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │    │ persistFriends()                             │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │<───┘                                              │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                      Friend added                        │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │────┐                                                     │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │    │ Add peerId to unsentFriends set                     │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │<───┘                                                     │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │ ╔════════════════════════════════════════════════════════╧═══════════╗                                       │                                                    │               ║
          ║            │                                                                      │                                              │                       │ ║Ephemeral tracking - peer IDs only, fetch data from FriendsManager ░║                                       │                                                    │               ║
          ║            │                                                                      │                                              │                       │ ╚════════════════════════════════════════════════════════╤═══════════╝                                       │                                                    │               ║
          ║            │                                                                      │                                              │                       │────┐                                                     │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │    │ Load hollowWorldSettings from storage               │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │<───┘                                                     │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │────┐                                                     │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │    │ myPlayerName = settings?.playerName || ''           │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │<───┘                                                     │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                  sendMessage(peerId, requestFriendMessage)                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │─────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │────┐                                               │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │    │ client.send(peerId, protocol, message, onAck) │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │<───┘                                               │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │       ╔══════╤════════╪══════════════════════════════════════════════════════════╪═══════════════════════════════════════════════════╪════════════════════════════════════╗               │               ║
          ║            │                                                                      │                                              │       ║ ALT  │  Peer is reachable                                                │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ╟──────┘        │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │────┐                               ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │    │ Message sent successfully     ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │<───┘                               ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │────┐                               ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │    │ Ack handler fires             ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │<───┘                               ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                          onAck() callback executed                                           │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │<─────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                    getFriend(peerId)                     │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │─────────────────────────────────────────────────────────>│                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                   current friend data                    │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │────┐                                                     │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │    │ Check if pending still 'unsent'                     │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │<───┘                                                     │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │     updateFriend(peerId, {..., pending: 'pending'})      │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │─────────────────────────────────────────────────────────>│                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │────┐                                              │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │    │ friends.set(peerId, updatedFriend)           │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │<───┘                                              │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │────┐                                              │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │    │ persistFriends()                             │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │<───┘                                              │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │────┐                                              │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │    │ notifyUpdateListeners(peerId, updatedFriend) │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │<───┘                                              │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │────┐                                                     │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │    │ unsentFriends.delete(peerId)                        │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │<───┘                                                     │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │ ╔═══════════════════════════════════════════════════════╗│                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │ ║Friend request delivered! Status changed to 'pending' ░║│                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │ ╚═══════════════════════════════════════════════════════╝│                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                Message sent                                                  │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                    ║               │               ║
          ║            │                                                                      │                                              │       ╠═══════════════╪══════════════════════════════════════════════════════════╪═══════════════════════════════════════════════════╪════════════════════════════════════╣               │               ║
          ║            │                                                                      │                                              │       ║ [Peer is unreachable]                                                    │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                 throw Error                                                  │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │────┐                                                     │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │    │ Catch error                                         │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │<───┘                                                     │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │                                                          │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │ ╔════════════════════════════════════════════════════════╧══════════════╗                                    │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │ ║Peer unreachable is NORMAL in P2P - don't throw                       ░║                                    │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │ ║Friend stays pending:'unsent', will auto-retry when peer comes online  ║                                    │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │ ╚════════════════════════════════════════════════════════╤══════════════╝                                    │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │─ ─ ┐                                                     │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │    | Log info (not error)                                │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ║               │< ─ ┘                                                     │                                                   │                                    ║               │               ║
          ║            │                                                                      │                                              │       ╚═══════════════╪══════════════════════════════════════════════════════════╪═══════════════════════════════════════════════════╪════════════════════════════════════╝               │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                         addFriend complete   │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                   log(`Added friend: ${friendName} (${friendPeerId})`)                                       │                                                    │               ║
          ║            │                                                                      │─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │────┐                                         │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │    │ hideAddFriendModal()                    │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │<───┘                                         │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │────┐                                         │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │    │ Clear modal inputs                      │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │<───┘                                         │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │────┐                                         │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │    │ render(container)                       │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │<───┘                                         │                       │                                                          │                                                   │                                                    │               ║
          ║            │                                                                      │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │Friends list refreshed with new friend (📤 Unsent or ⏳ Pending badge) │                                              │                       │                                                          │                                                   │                                                    │               ║
          ║            │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                              │                       │                                                          │                                                   │                                                    │               ║
          ╚════════════╪══════════════════════════════════════════════════════════════════════╪══════════════════════════════════════════════╪═══════════════════════╪══════════════════════════════════════════════════════════╪═══════════════════════════════════════════════════╪════════════════════════════════════════════════════╪═══════════════╝
                    ┌──┴─┐                                                              ┌─────┴─────┐                                 ┌──────┴──────┐          ┌─────┴────┐                                             ┌───────┴──────┐                               ┌────────────┴───────────┐                                  ┌─────┴────┐           
                    │User│                                                              │FriendsView│                                 │MilkdownUtils│          │HollowPeer│                                             │FriendsManager│                               │P2PWebAppNetworkProvider│                                  │LogService│           
                    └────┘                                                              └───────────┘                                 └─────────────┘          └──────────┘                                             └──────────────┘                               └────────────────────────┘                                  └──────────┘           
```

## Stubborn Delivery (Auto-Retry)

```
                                        ┌────────────────────────┐                               ┌──────────┐                                             ┌──────────────┐                                                
                                        │P2PWebAppNetworkProvider│                               │HollowPeer│                                             │FriendsManager│                                                
                                        └────────────┬───────────┘                               └─────┬────┘                                             └───────┬──────┘                                                
                                          ╔══════════╧═════════════════════════════════════════════════╧══════════════════════════════════════════════════════════╧═══════════╗                                           
                                          ║If peer was unreachable (pending: 'unsent')                                                                                       ░║                                           
                                          ║Later: Peer comes online (while user's app is running)                                                                             ║                                           
                                          ╚══════════╤═════════════════════════════════════════════════╤══════════════════════════════════════════════════════════╤═══════════╝                                           
                                                     │────┐                                            │                                                          │                                                       
                                                     │    │ handlePeerJoined(peerId)                   │                                                          │                                                       
                                                     │<───┘                                            │                                                          │                                                       
                                                     │                                                 │                                                          │                                                       
                                                     │────┐                                            │                                                          │                                                       
                                                     │    │ connectedPeers.add(peerId)                 │                                                          │                                                       
                                                     │<───┘                                            │                                                          │                                                       
                                                     │                                                 │                                                          │                                                       
                                                     │           peerConnectHandler(peerId)            │                                                          │                                                       
                                                     │────────────────────────────────────────────────>│                                                          │                                                       
                                                     │                                                 │                                                          │                                                       
                                                     │                                                 │────┐                                                     │                                                       
                                                     │                                                 │    │ handlePeerConnection(peerId)                        │                                                       
                                                     │                                                 │<───┘                                                     │                                                       
                                                     │                                                 │                                                          │                                                       
                                                     │                                                 │────┐                                                     │                                                       
                                                     │                                                 │    │ Check if peerId in unsentFriends set                │                                                       
                                                     │                                                 │<───┘                                                     │                                                       
                                                     │                                                 │                                                          │                                                       
                                                     │                                                 │                                                          │                                                       
          ╔══════╤═══════════════════════════════════╪═════════════════════════════════════════════════╪══════════════════════════════════════════════════════════╪══════════════════════════════════════════════════════╗
          ║ ALT  │  Peer in unsentFriends set        │                                                 │                                                          │                                                      ║
          ╟──────┘                                   │                                                 │                                                          │                                                      ║
          ║                                          │                                                 │                    getFriend(peerId)                     │                                                      ║
          ║                                          │                                                 │─────────────────────────────────────────────────────────>│                                                      ║
          ║                                          │                                                 │                                                          │                                                      ║
          ║                                          │                                                 │          friend data (single source of truth)            │                                                      ║
          ║                                          │                                                 │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                      ║
          ║                                          │                                                 │                                                          │                                                      ║
          ║                                          │                                                 │────┐                                                     │                                                      ║
          ║                                          │                                                 │    │ Check friend.pending === 'unsent'                   │                                                      ║
          ║                                          │                                                 │<───┘                                                     │                                                      ║
          ║                                          │                                                 │                                                          │                                                      ║
          ║                                          │                                                 │                                                          │                                                      ║
          ║         ╔══════╤═════════════════════════╪═════════════════════════════════════════════════╪══════════════════════════════════════════════════════════╪════════════════════════════════════════════╗         ║
          ║         ║ ALT  │  Friend has unsent request                                                │                                                          │                                            ║         ║
          ║         ╟──────┘                         │                                                 │                                                          │                                            ║         ║
          ║         ║                                │                                                 │────┐                                                     │                                            ║         ║
          ║         ║                                │                                                 │    │ Log "Auto-retrying friend request to ${playerName}" │                                            ║         ║
          ║         ║                                │                                                 │<───┘                                                     │                                            ║         ║
          ║         ║                                │                                                 │                                                          │                                            ║         ║
          ║         ║                                │                                                 │────┐                                                     │                                            ║         ║
          ║         ║                                │                                                 │    │ Create IRequestFriendMessage                        │                                            ║         ║
          ║         ║                                │                                                 │<───┘                                                     │                                            ║         ║
          ║         ║                                │                                                 │                                                          │                                            ║         ║
          ║         ║                                │sendMessage(peerId, requestFriendMessage, onAck) │                                                          │                                            ║         ║
          ║         ║                                │<────────────────────────────────────────────────│                                                          │                                            ║         ║
          ║         ║                                │                                                 │                                                          │                                            ║         ║
          ║         ║                                │                                                 │                                                          │                                            ║         ║
          ║         ║         ╔══════╤═══════════════╪═════════════════════════════════════════════════╪══════════════════════════════════════════════════════════╪══════════════════════════════════╗         ║         ║
          ║         ║         ║ ALT  │  Message delivered successfully                                 │                                                          │                                  ║         ║         ║
          ║         ║         ╟──────┘               │                                                 │                                                          │                                  ║         ║         ║
          ║         ║         ║                      │                onAck() callback                 │                                                          │                                  ║         ║         ║
          ║         ║         ║                      │────────────────────────────────────────────────>│                                                          │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │     updateFriend(peerId, {..., pending: 'pending'})      │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │─────────────────────────────────────────────────────────>│                                  ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │────┐                             ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │    │ persistFriends()            ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │<───┘                             ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │────┐                             ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │    │ notifyUpdateListeners()     ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │<───┘                             ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │────┐                                                     │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │    │ unsentFriends.delete(peerId)                        │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │<───┘                                                     │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │                                                          │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │ ╔═══════════════════════════════╗                        │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │ ║Status changed to 'pending' ⏳ ░║                        │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │ ║Stubborn delivery succeeded!   ║                        │                                  ║         ║         ║
          ║         ║         ╠══════════════════════╪═════════════════════════════════════════════════╪══════════════════════════════════════════════════════════╪══════════════════════════════════╣         ║         ║
          ║         ║         ║ [Message still unreachable]                                            │                                                          │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │ ╔════════════════════════════════════╗                   │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │ ║Friend stays pending: 'unsent' 📤  ░║                   │                                  ║         ║         ║
          ║         ║         ║                      │                                                 │ ║Will retry on next peer connection  ║                   │                                  ║         ║         ║
          ║         ║         ╚══════════════════════╪═════════════════════════════════════════════════╪═╚════════════════════════════════════╝═══════════════════╪══════════════════════════════════╝         ║         ║
          ║         ╚════════════════════════════════╪═════════════════════════════════════════════════╪══════════════════════════════════════════════════════════╪════════════════════════════════════════════╝         ║
          ╚══════════════════════════════════════════╪═════════════════════════════════════════════════╪══════════════════════════════════════════════════════════╪══════════════════════════════════════════════════════╝
                                        ┌────────────┴───────────┐                               ┌─────┴────┐                                             ┌───────┴──────┐                                                
                                        │P2PWebAppNetworkProvider│                               │HollowPeer│                                             │FriendsManager│                                                
                                        └────────────────────────┘                               └──────────┘                                             └──────────────┘                                                
```

## Spec Intent

Matches spec requirements:
- **Peer ID Validation**: Check base58 format before adding
- **Notes Support**: Milkdown editor for rich markdown notes
- **Stubborn Delivery**: Auto-retry unsent requests when peer connects
- **Two-State Pending**: 'unsent' (not delivered) vs 'pending' (delivered)
- **Non-Blocking**: Peer unreachable is normal, not an error
- **Ephemeral Tracking**: unsentFriends set for retry logic
- **Friend Badge**: UI shows 📤 Unsent or ⏳ Pending status
- **Log Integration**: Record friend additions to application log

## Analysis

### Correctly Implemented ✅

1. **Peer ID Validation**: Base58 format check prevents invalid IDs
2. **Rich Notes**: Milkdown editor with markdown support
3. **Stubborn Delivery**: Auto-retry via unsentFriends set
4. **Ack Handler Pattern**: Change pending status only after delivery
5. **Non-Blocking**: Peer unreachable logged as info, not error
6. **Ephemeral Set**: unsentFriends stores peer IDs only (data from FriendsManager)
7. **Friend Data Source**: Single source of truth pattern with FriendsManager
8. **Auto-Retry on Connect**: Peer connection event triggers retry
9. **Status Badges**: UI shows delivery status (📤 unsent, ⏳ pending)
10. **Log Integration**: Friend additions recorded for audit trail

### No Issues Found

Implementation follows spec exactly with proper stubborn delivery pattern.
