# Sequence: Establish P2P Connection

**Source Spec:** specs/p2p.md
**Existing Code:** src/p2p/P2PWebAppNetworkProvider.ts, src/p2p/HollowPeer.ts

## Participants

- **main.ts**
- **HollowPeer** (src/p2p/HollowPeer.ts)
- **P2PWebAppNetworkProvider** (src/p2p/P2PWebAppNetworkProvider.ts)
- **P2PWebAppClient** (src/p2p/client/client.js)
- **FriendsManager** (src/p2p/FriendsManager.ts)
- **LocalStorage**

## Current Implementation

```
       ┌───────┐              ┌──────────┐                        ┌────────────────────────┐                                            ┌───────────────┐                                        ┌──────────────┐                                    ┌────────────┐
       │main.ts│              │HollowPeer│                        │P2PWebAppNetworkProvider│                                            │P2PWebAppClient│                                        │FriendsManager│                                    │LocalStorage│
       └───┬───┘              └─────┬────┘                        └────────────┬───────────┘                                            └───────┬───────┘                                        └───────┬──────┘                                    └──────┬─────┘
           │     initialize()       │                                          │                                                                │                                                        │                                                  │
           │───────────────────────>│                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │              initialize()                │                                                                │                                                        │                                                  │
           │                        │─────────────────────────────────────────>│                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │      Load peer key (profile-aware)                     │                                                  │
           │                        │                                          │───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │         storedKey or undefined                         │                                                  │
           │                        │                                          │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │    Load settings (protocol + topic)                    │                                                  │
           │                        │                                          │───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │       {peerProtocol, pubsubTopic}                      │                                                  │
           │                        │                                          │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │────┐                                                           │                                                        │                                                  │
           │                        │                                          │    │ protocol = settings.peerProtocol || '/hollow-world/1.0.0' │                                                        │                                                  │
           │                        │                                          │<───┘                                                           │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │────┐                                                           │                                                        │                                                  │
           │                        │                                          │    │ topic = settings.pubsubTopic || 'hollow-world'            │                                                        │                                                  │
           │                        │                                          │<───┘                                                           │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                      connect(storedKey)                        │ ╔══════════════════════════════════════════════════════╧╗                                                 │
           │                        │                                          │───────────────────────────────────────────────────────────────>│ ║WebSocket URL auto-detected from window.location.host ░║                                                 │
           │                        │                                          │                                                                │ ╚══════════════════════════════════════════════════════╤╝                                                 │
           │                        │                                          │                                                                │────┐                                                   │                                                  │
           │                        │                                          │                                                                │    │ Connect to WebSocket                              │                                                  │
           │                        │                                          │                                                                │<───┘                                                   │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │────┐                                                   │                                                  │
           │                        │                                          │                                                                │    │ Initialize peer with stored key (or generate new) │                                                  │
           │                        │                                          │                                                                │<───┘                                                   │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                       [peerID, peerKey]                        │                                                        │                                                  │
           │                        │                                          │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │────┐                                                           │                                                        │                                                  │
           │                        │                                          │    │ Store peerID and peerKey                                  │                                                        │                                                  │
           │                        │                                          │<───┘                                                           │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                   ╔══════╤═══════════════╪════════════════════════════════════════════════════════════════╪════════════════════════════════════════════════════════╪══════════════════════════════════════════════════╪════════════════╗
           │                        │                   ║ ALT  │  No stored key (first run)                                                     │                                                        │                                                  │                ║
           │                        │                   ╟──────┘               │                                                                │                                                        │                                                  │                ║
           │                        │                   ║                      │                                                                │      Store peerKey (profile-aware)                     │                                                  │                ║
           │                        │                   ║                      │───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                ║
           │                        │                   ╚══════════════════════╪════════════════════════════════════════════════════════════════╪════════════════════════════════════════════════════════╪══════════════════════════════════════════════════╪════════════════╝
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                start(protocol, messageHandler)                 │ ╔═════════════════════════════════════════════════╗    │                                                  │
           │                        │                                          │───────────────────────────────────────────────────────────────>│ ║protocol = '/hollow-world/1.0.0' (configurable) ░║    │                                                  │
           │                        │                                          │                                                                │ ╚═════════════════════════════════════════════════╝    │                                                  │
           │                        │                                          │                                                                │────┐                                                   │                                                  │
           │                        │                                          │                                                                │    │ Register message handler for protocol             │                                                  │
           │                        │                                          │                                                                │<───┘                                                   │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                       Protocol started                         │                                                        │                                                  │
           │                        │                                          │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │       subscribe(topic, topicHandler, peerChangeHandler)        │ ╔═════════════════════════════════════════════════╗    │                                                  │
           │                        │                                          │───────────────────────────────────────────────────────────────>│ ║topic = 'hollow-world' (configurable)           ░║    │                                                  │
           │                        │                                          │                                                                │ ║Third parameter monitors peer join/leave events  ║    │                                                  │
           │                        │                                          │                                                                │ ╚═════════════════════════════════════════════════╝    │                                                  │
           │                        │                                          │                                                                │────┐                                                   │                                                  │
           │                        │                                          │                                                                │    │ Subscribe to pubsub topic                         │                                                  │
           │                        │                                          │                                                                │<───┘                                                   │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │────┐                                                   │                                                  │
           │                        │                                          │                                                                │    │ Register peer change monitoring                   │                                                  │
           │                        │                                          │                                                                │<───┘                                                   │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                  Subscribed with monitoring                    │                                                        │                                                  │
           │                        │                                          │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                       listPeers(topic)                         │                                                        │                                                  │
           │                        │                                          │───────────────────────────────────────────────────────────────>│                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │             Array of currently connected peer IDs              │                                                        │                                                  │
           │                        │                                          │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │────┐                                                           │                                                        │                                                  │
           │                        │                                          │    │ connectedPeers = new Set(peers)                           │                                                        │                                                  │
           │                        │                                          │<───┘                                                           │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │           Network initialized            │                                                                │                                                        │                                                  │
           │                        │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                loadFriends()                   │                                                        │                                                  │
           │                        │───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │              Load 'hollow-friends'               │
           │                        │                                          │                                                                │                                                        │─────────────────────────────────────────────────>│
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                  Friends data                    │
           │                        │                                          │                                                                │                                                        │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │────┐                                             │
           │                        │                                          │                                                                │                                                        │    │ Initialize worlds array for backward compat │
           │                        │                                          │                                                                │                                                        │<───┘                                             │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │           Load 'hollow-banned-peers'             │
           │                        │                                          │                                                                │                                                        │─────────────────────────────────────────────────>│
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                  Ban list data                   │
           │                        │                                          │                                                                │                                                        │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │                                       Friends loaded                                                     │                                                        │                                                  │
           │                        │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │────┐                                     │                                                                │                                                        │                                                  │
           │                        │    │ populateUnsentFriendsSet()          │                                                                │                                                        │                                                  │
           │                        │<───┘                                     │                                                                │                                                        │                                                  │
           │                        │                                          │                                                                │                                                        │                                                  │
           │                        │   ╔═════════════╤══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╗ │
           │                        │   ║ LOOP        │  For each friend with pending: 'unsent'                                                │                                                        │                                                  │ ║ │
           │                        │   ╟─────────────┘  │                                                                                       │                                                        │                                                  │ ║ │
           │                        │   ║                │────┐                                                                                  │                                                        │                                                  │ ║ │
           │                        │   ║                │    │ unsentFriends.add(peerId)                                                        │                                                        │                                                  │ ║ │
           │                        │   ║                │<───┘                                                                                  │                                                        │                                                  │ ║ │
           │                        │   ╚════════════════╪══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╝ │
           │                        │                    │                                                                                       │                                                        │                                                  │
           │                        │────┐               │                                                                                       │                                                        │                                                  │
           │                        │    │ Setup message handler                                                                                │                                                        │                                                  │
           │                        │<───┘               │                                                                                       │                                                        │                                                  │
           │                        │                    │                                                                                       │                                                        │                                                  │
           │                        │   onMessage(handleMessage)                                                                                │                                                        │                                                  │
           │                        │───────────────────────────────────────────────>│                                                          │                                                        │                                                  │
           │                        │                                                │                                                          │                                                        │                                                  │
           │                        │────┐                                           │                                                          │                                                        │                                                  │
           │                        │    │ Setup peer connect handler                │                                                          │                                                        │                                                  │
           │                        │<───┘                                           │                                                          │                                                        │                                                  │
           │                        │                                                │                                                          │                                                        │                                                  │
           │                        │             onPeerConnect(handlePeerConnection)│                                                          │                                                        │                                                  │
           │                        │───────────────────────────────────────────────>│                                                          │                                                        │                                                  │
           │                        │                                                │                                                          │                                                        │                                                  │
           │                        │────┐                                           │                                                          │                                                        │                                                  │
           │                        │    │ Setup peer disconnect handler             │                                                          │                                                        │                                                  │
           │                        │<───┘                                           │                                                          │                                                        │                                                  │
           │                        │                                                │                                                          │                                                        │                                                  │
           │                        │       onPeerDisconnect(handlePeerDisconnection)│                                                          │                                                        │                                                  │
           │                        │───────────────────────────────────────────────>│                                                          │                                                        │                                                  │
           │                        │                                                │                                                          │                                                        │                                                  │
           │                        │────┐                                           │                                                          │                                                        │                                                  │
           │                        │    │ initializeFriendPresence()                │                                                          │                                                        │                                                  │
           │                        │<───┘                                           │                                                          │                                                        │                                                  │
           │                        │                                                │                                                          │                                                        │                                                  │
           │                        │            getConnectedPeers()                 │                                                          │                                                        │                                                  │
           │                        │───────────────────────────────────────────────>│                                                          │                                                        │                                                  │
           │                        │                                                │                                                          │                                                        │                                                  │
           │                        │             Array of peer IDs                  │                                                          │                                                        │                                                  │
           │                        │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                          │                                                        │                                                  │
           │                        │                                                │                                                          │                                                        │                                                  │
           │                        │                                      getAllFriends()                                                      │                                                        │                                                  │
           │                        │───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                                                  │
           │                        │                                                │                                                          │                                                        │                                                  │
           │                        │                                            Map of friends                                                 │                                                        │                                                  │
           │                        │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                  │
           │                        │                                                │                                                          │                                                        │                                                  │
           │                        │ ╔═════════════╤════════════════════════════════╪══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╪══════════════════════════════════════════════════╪════════════════╗ │
           │                        │ ║ LOOP        │  For each friend               │                                                          │                                                        │                                                  │                ║ │
           │                        │ ╟─────────────┘  │                             │                                                          │                                                        │                                                  │                ║ │
           │                        │ ║                │────┐                        │                                                          │                                                        │                                                  │                ║ │
           │                        │ ║                │    │ Check if peerId in connectedPeers                                                 │                                                        │                                                  │                ║ │
           │                        │ ║                │<───┘                        │                                                          │                                                        │                                                  │                ║ │
           │                        │ ║                │                             │                                                          │                                                        │                                                  │                ║ │
           │                        │ ║                │                             │                                                          │                                                        │                                                  │                ║ │
           │                        │ ║  ╔══════╤═════╪═════════════════════════════╪══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╪══════════════════════════════════════════════════╪════════════════╝ ║ │
           │                        │ ║  ║ ALT  │  Peer online                      │                                                          │                                                        │                                                  │                  ║ │
           │                        │ ║  ╟──────┘     │                             │                                                          │                                                        │                                                  │                  ║ │
           │                        │ ║  ║            │                             │                    updateFriend(peerId, {..., presence: true})                                                    │                                                  │                  ║ │
           │                        │ ║  ║            │───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                                                  │                  ║ │
           │                        │ ║  ╠════════════╪═════════════════════════════╪══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╪══════════════════════════════════════════════════╪════════════════╗ ║ │
           │                        │ ║  ║ [Peer offline]                           │                                                          │                                                        │                                                  │                ║ ║ │
           │                        │ ║  ║            │                             │                   updateFriend(peerId, {..., presence: false})                                                    │                                                  │                ║ ║ │
           │                        │ ║  ║            │───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                                                  │                ║ ║ │
           │                        │ ║  ╚════════════╪═════════════════════════════╪══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╪══════════════════════════════════════════════════╪════════════════╝ ║ │
           │                        │ ╚═══════════════╪═════════════════════════════╪══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╪══════════════════════════════════════════════════╪════════════════╝ │
           │                        │                 │                             │                                                          │                                                        │                                                  │
           │                        │────┐            │                             │                                                          │                                                        │                                                  │
           │                        │    │ startResendTimer()                       │ ╔════════════════════════════════════════════════════════╧══╗                                                     │                                                  │
           │                        │<───┘            │                             │ ║Start periodic timer for resendable message retry       ░║                                                     │                                                  │
           │                        │                 │                             │ ╚════════════════════════════════════════════════════════╤══╝                                                     │                                                  │
           │                        │                 │                             │                                                          │                                                        │                                                  │
           │Initialization complete │                 │                             │                                                          │                                                        │                                                  │
           │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                 │                             │                                                          │                                                        │                                                  │
       ┌───┴───┐              ┌─────┴────┐            │────────────┬───────────┘                                            ┌───────┴───────┐                                        ┌───────┴──────┐                                    ┌──────┴─────┐
       │main.ts│              │HollowPeer│            │P2PWebAppNetworkProvider│                                            │P2PWebAppClient│                                        │FriendsManager│                                    │LocalStorage│
       └───────┘              └──────────┘            └────────────────────────┘                                            └───────────────┘                                        └──────────────┘                                    └────────────┘```

## Peer Join Event

```
     ┌───────────────┐           ┌────────────────────────┐               ┌──────────┐
     │P2PWebAppClient│           │P2PWebAppNetworkProvider│               │HollowPeer│
     └───────┬───────┘           └────────────┬───────────┘               └─────┬────┘
     ╔═══════╧════════════════════════════════╧═════════════════════════════════╧═══════╗
     ║Later: Peer joins hollow-world topic                                             ░║
     ╚═══════╤════════════════════════════════╤═════════════════════════════════╤═══════╝
             │────┐                           │                                 │
             │    │ Detect peer joined event  │                                 │
             │<───┘                           │                                 │
             │                                │                                 │
             │peerChangeHandler(peerId, true) │                                 │
             │───────────────────────────────>│                                 │
             │                                │                                 │
             │                                │────┐                            │
             │                                │    │ handlePeerJoined(peerId)   │
             │                                │<───┘                            │
             │                                │                                 │
             │                                │────┐                            │
             │                                │    │ connectedPeers.add(peerId) │
             │                                │<───┘                            │
             │                                │                                 │
             │                                │   peerConnectHandler(peerId)    │
             │                                │────────────────────────────────>│
             │                                │                                 │
             │                                │                                 │────┐
             │                                │                                 │    │ handlePeerConnection(peerId)
             │                                │                                 │<───┘
             │                                │                                 │
             │                                │                                 │────┐
             │                                │                                 │    │ updateFriendPresence(peerId, true)
             │                                │                                 │<───┘
             │                                │                                 │
             │                                │                                 │────┐
             │                                │                                 │    │ Check if peerId in unsentFriends → auto-retry
             │                                │                                 │<───┘
     ┌───────┴───────┐           ┌────────────┴───────────┐               ┌─────┴────┐
     │P2PWebAppClient│           │P2PWebAppNetworkProvider│               │HollowPeer│
     └───────────────┘           └────────────────────────┘               └──────────┘```

## Peer Leave Event

```
     ┌───────────────┐            ┌────────────────────────┐                  ┌──────────┐
     │P2PWebAppClient│            │P2PWebAppNetworkProvider│                  │HollowPeer│
     └───────┬───────┘            └────────────┬───────────┘                  └─────┬────┘
     ╔═══════╧═════════════════════════════════╧════════════════════════════════════╧═══════╗
     ║Later: Peer leaves hollow-world topic                                                ░║
     ╚═══════╤═════════════════════════════════╤════════════════════════════════════╤═══════╝
             │────┐                            │                                    │
             │    │ Detect peer left event     │                                    │
             │<───┘                            │                                    │
             │                                 │                                    │
             │peerChangeHandler(peerId, false) │                                    │
             │────────────────────────────────>│                                    │
             │                                 │                                    │
             │                                 │────┐                               │
             │                                 │    │ handlePeerLeft(peerId)        │
             │                                 │<───┘                               │
             │                                 │                                    │
             │                                 │────┐                               │
             │                                 │    │ connectedPeers.delete(peerId) │
             │                                 │<───┘                               │
             │                                 │                                    │
             │                                 │   peerDisconnectHandler(peerId)    │
             │                                 │───────────────────────────────────>│
             │                                 │                                    │
             │                                 │                                    │────┐
             │                                 │                                    │    │ handlePeerDisconnection(peerId)
             │                                 │                                    │<───┘
             │                                 │                                    │
             │                                 │                                    │────┐
             │                                 │                                    │    │ updateFriendPresence(peerId, false)
             │                                 │                                    │<───┘
     ┌───────┴───────┐            ┌────────────┴───────────┐                  ┌─────┴────┐
     │P2PWebAppClient│            │P2PWebAppNetworkProvider│                  │HollowPeer│
     └───────────────┘            └────────────────────────┘                  └──────────┘```

## Spec Intent

Matches spec requirements:
- **WebSocket connection**: Auto-detect URL, connect to p2p-webapp server
- **Peer key persistence**: Store key for session continuity
- **Protocol + Topic**: Configurable via Settings (defaults: `/hollow-world/1.0.0`, `hollow-world`)
- **Pubsub discovery**: Subscribe to topic for peer discovery
- **Peer monitoring**: Integrated peer join/leave tracking
- **Friend presence**: Initialize online/offline status from connected peers
- **Stubborn requests**: Populate unsentFriends for auto-retry

## Analysis

### Correctly Implemented ✅

1. **Single connect() call**: WebSocket + peer init in one operation
2. **Peer key persistence**: Profile-aware storage for multi-profile support
3. **Settings integration**: Load protocol and topic from settings
4. **Peer change monitoring**: Integrated into subscribe() call
5. **Initial peer list**: Use listPeers() to get currently connected peers
6. **Friend presence init**: Set online/offline based on connected peers
7. **Event handlers**: Register all handlers before processing events
8. **Backward compatibility**: Initialize worlds array for existing friends

### No Issues Found

Implementation is clean and follows spec exactly.
